# Database Deployment Guide

## Quick Diagnosis

After deployment, visit your app URL and go to `/debug/db_status` to check:
- `USE_DATABASE`: Should be `true` in production
- `DATABASE_URL_exists`: Should be `true`
- Database configuration status

## Deployment Process

### 1. Render.yaml Configuration
The `render.yaml` file is configured to:
- Create a PostgreSQL database (`frat-treasurer-db`)
- Set the `DATABASE_URL` environment variable automatically
- Run database initialization during build: `python database.py force-init`

### 2. Database Initialization
During deployment, the system will:
1. Install dependencies
2. Run `python database.py force-init` to create tables
3. Create default roles (admin, treasurer, president, etc.)
4. Create a default treasurer user if none exists

### 3. Initial Treasurer Account
If no treasurer exists, the system creates Ebubechi Onyia as treasurer:
- **Phone**: 4438751825
- **Password**: treasurer2024
- **Email**: ebubechi@example.com (update in Treasurer Setup)

**⚠️ NOTE**: Update your real email address in "Treasurer Setup" after first login.

## Manual Database Management

### Check Database Status
```bash
python database.py status
```

### Force Initialize Database
```bash
python database.py force-init
```

### Create New Treasurer
```bash
python database.py create-treasurer <phone> <first_name> <last_name> <password>
```

## Troubleshooting

### Issue: Data Not Persisting
**Cause**: App running in JSON mode instead of database mode

**Solution**: 
1. Check `/debug/db_status` endpoint
2. Verify `USE_DATABASE` is `true`
3. If false, check Render environment variables

### Issue: Login Fails
**Cause**: No treasurer user created

**Solutions**:
1. Use Ebubechi's credentials: 4438751825 / treasurer2024
2. Or create new user: `python database.py create-treasurer ...`

### Issue: Database Connection Fails
**Cause**: DATABASE_URL not properly set

**Solution**: 
1. Check Render dashboard for database service
2. Verify environment variables are connected
3. Check build logs for connection errors

## Environment Variables (Set in Render Dashboard)

Required:
- `DATABASE_URL`: Auto-set by Render database service
- `SECRET_KEY`: Auto-generated by Render
- `FLASK_ENV`: Set to `production`

Optional:
- `SMTP_USERNAME`: For email notifications
- `SMTP_PASSWORD`: Gmail app password
- `TWILIO_SID`: For SMS notifications
- `TWILIO_TOKEN`: Twilio auth token
- `TWILIO_PHONE`: Your Twilio phone number

## Database Migration

### From JSON to Database
If you have existing JSON data files, use:
```bash
python migrate_data.py
```

This will:
1. Read existing JSON files
2. Convert to database format
3. Preserve all transaction and member data

## Startup Logs to Monitor

Watch for these messages during deployment:
- ✅ `Database models loaded successfully`
- ✅ `App initialized with database support`
- ✅ `Database tables initialized successfully`
- ✅ `Created default treasurer user`

If you see:
- ❌ `Falling back to JSON mode` - Database connection failed
- ⚠️ `Database initialization warning` - Tables might exist already

## Quick Commands for Production

### After First Deployment
1. Visit `/debug/db_status` to verify database mode
2. Login with: 4438751825 / treasurer2024
3. Go to "Treasurer Setup" to update your real email
4. Set up email/SMS notifications if desired

### For Ongoing Management
- Use the web interface for all data management
- Export data regularly via "Export Data" feature
- Monitor via Render dashboard logs