{% extends "base.html" %}

{% block title %}All Transactions - Fraternity Treasurer{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block extra_styles %}
.transaction-income { border-left: 4px solid #28a745; }
.transaction-expense { border-left: 4px solid #dc3545; }
.transaction-outstanding { border-left: 4px solid #ffc107; }
.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
.status-completed { background-color: #d4edda; color: #155724; }
.status-pending { background-color: #fff3cd; color: #856404; }
.status-overdue { background-color: #f8d7da; color: #721c24; }
.summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}
.amount-positive { color: #28a745; font-weight: 600; }
.amount-negative { color: #dc3545; font-weight: 600; }
.amount-warning { color: #ffc107; font-weight: 600; }
.table-responsive {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.filter-buttons {
    margin-bottom: 1rem;
}
.filter-btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}
{% endblock %}

{% block page_title %}
<i class="fas fa-list-ul me-2"></i>All Financial Transactions
{% endblock %}

{% block content %}
                
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">
                                    <i class="fas fa-arrow-up me-2"></i>Total Income
                                </h5>
                                <h3 class="amount-positive">${{ "%.2f"|format(total_income) }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">
                                    <i class="fas fa-arrow-down me-2"></i>Total Expenses
                                </h5>
                                <h3 class="amount-negative">${{ "%.2f"|format(total_expenses) }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning">
                                    <i class="fas fa-clock me-2"></i>Outstanding Dues
                                </h5>
                                <h3 class="amount-warning">${{ "%.2f"|format(total_outstanding) }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Net Balance Card -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="summary-card text-center">
                            <h4><i class="fas fa-calculator me-2"></i>Net Financial Position</h4>
                            {% set net_balance = total_income - total_expenses %}
                            <h2>
                                {% if net_balance >= 0 %}
                                    <i class="fas fa-plus-circle me-2"></i>${{ "%.2f"|format(net_balance) }}
                                {% else %}
                                    <i class="fas fa-minus-circle me-2"></i>-${{ "%.2f"|format(net_balance|abs) }}
                                {% endif %}
                            </h2>
                            <p class="mb-0">Current Balance (excluding outstanding dues)</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div class="filter-buttons">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Filter by Type:</h6>
                            <button class="btn btn-outline-primary filter-btn" onclick="filterTransactions('all')">
                                <i class="fas fa-list me-1"></i>All Items
                            </button>
                            <button class="btn btn-outline-success filter-btn" onclick="filterTransactions('income')">
                                <i class="fas fa-arrow-up me-1"></i>Income Only
                            </button>
                            <button class="btn btn-outline-danger filter-btn" onclick="filterTransactions('expense')">
                                <i class="fas fa-arrow-down me-1"></i>Expenses Only
                            </button>
                            <button class="btn btn-outline-warning filter-btn" onclick="filterTransactions('outstanding')">
                                <i class="fas fa-clock me-1"></i>Outstanding Dues
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Filter by Category:</h6>
                            <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                                <option value="all">All Categories</option>
                                {% set categories = transactions|map(attribute='category')|unique|list %}
                                {% for category in categories|sort %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Transaction Details
                            <span class="badge bg-light text-dark ms-2" id="itemCount">{{ transactions|length }} items</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Member</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    {% for item in transactions %}
                                    <tr class="transaction-row transaction-{{ item.transaction_type }}" 
                                        data-type="{{ item.transaction_type }}"
                                        data-category="{{ item.category }}"
                                        data-member="{{ item.member_name or '' }}">
                                        <td>
                                            <div class="fw-bold">{{ item.date_str.split(' ')[0] }}</div>
                                            {% if ' ' in item.date_str %}
                                            <small class="text-muted">{{ item.date_str.split(' ')[1] }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.transaction_type == 'income' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-arrow-up me-1"></i>Income
                                                </span>
                                            {% elif item.transaction_type == 'expense' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-arrow-down me-1"></i>Expense
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock me-1"></i>Due
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ item.category }}</span>
                                        </td>
                                        <td>
                                            <div class="fw-bold">{{ item.description }}</div>
                                        </td>
                                        <td>
                                            {% if item.member_name %}
                                                <div class="text-primary fw-bold">{{ item.member_name }}</div>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.transaction_type == 'income' %}
                                                <span class="amount-positive">+${{ "%.2f"|format(item.amount) }}</span>
                                            {% elif item.transaction_type == 'expense' %}
                                                <span class="amount-negative">-${{ "%.2f"|format(item.amount) }}</span>
                                            {% else %}
                                                <span class="amount-warning">${{ "%.2f"|format(item.amount) }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.status == 'completed' %}
                                                <span class="badge status-completed">
                                                    <i class="fas fa-check me-1"></i>Completed
                                                </span>
                                            {% elif item.status == 'pending' %}
                                                <span class="badge status-pending">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                            {% elif item.status == 'overdue' %}
                                                <span class="badge status-overdue">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Overdue
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.type == 'transaction' %}
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{{ url_for('edit_transaction', transaction_id=item.id) }}" 
                                                       class="btn btn-outline-primary btn-sm" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <form method="POST" action="{{ url_for('remove_transaction', transaction_id=item.id) }}" 
                                                          class="d-inline" 
                                                          onsubmit="return confirm('Are you sure you want to delete this transaction?')">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            {% elif item.type == 'payment' %}
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{{ url_for('edit_payment', payment_id=item.id.replace('payment_', '')) }}" 
                                                       class="btn btn-outline-primary btn-sm" title="Edit Payment">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <form method="POST" action="{{ url_for('remove_payment', payment_id=item.id.replace('payment_', '')) }}" 
                                                          class="d-inline" 
                                                          onsubmit="return confirm('Are you sure you want to delete this payment?')">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete Payment">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            {% elif item.type == 'outstanding' %}
                                                <small class="text-muted">Outstanding dues</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- No Results Message (initially hidden) -->
                <div id="noResultsMessage" class="alert alert-info text-center mt-3" style="display: none;">
                    <i class="fas fa-search me-2"></i>No transactions match the current filter.
                </div>

                <!-- Back to Dashboard -->
                <div class="text-center mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables for filtering
    let currentTypeFilter = 'all';
    let currentCategoryFilter = 'all';

    function filterTransactions(type) {
        currentTypeFilter = type;
        applyFilters();
        
        // Update button states
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        
        event.target.classList.remove('btn-outline-primary');
        event.target.classList.add('btn-primary');
    }

    function filterByCategory() {
        currentCategoryFilter = document.getElementById('categoryFilter').value;
        applyFilters();
    }

    function applyFilters() {
        const tbody = document.getElementById('transactionsTableBody');
        const rows = tbody.getElementsByTagName('tr');
        const noResultsMessage = document.getElementById('noResultsMessage');
        let visibleCount = 0;

        for (let row of rows) {
            let showRow = true;
            
            // Type filter
            if (currentTypeFilter !== 'all') {
                const rowType = row.getAttribute('data-type');
                if (rowType !== currentTypeFilter) {
                    showRow = false;
                }
            }
            
            // Category filter
            if (showRow && currentCategoryFilter !== 'all') {
                const rowCategory = row.getAttribute('data-category');
                if (rowCategory !== currentCategoryFilter) {
                    showRow = false;
                }
            }
            
            if (showRow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
        
        // Update item count
        document.getElementById('itemCount').textContent = visibleCount + ' items';
        
        // Show/hide no results message
        if (visibleCount === 0) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
    }

    // Initialize with all items filter active
    document.addEventListener('DOMContentLoaded', function() {
        const firstFilterBtn = document.querySelector('.filter-btn');
        if (firstFilterBtn) {
            firstFilterBtn.classList.remove('btn-outline-primary');
            firstFilterBtn.classList.add('btn-primary');
        }
    });
</script>
{% endblock %}
