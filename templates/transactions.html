<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Transactions - Fraternity Treasurer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Light mode variables */
            --bg-color: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-color: #212529;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --card-header-bg: #f8f9fa;
            --border-color: #dee2e6;
            --navbar-bg: #343a40;
            --navbar-text: #ffffff;
            --table-border: #dee2e6;
            --shadow: rgba(0,0,0,0.15);
        }
        
        [data-theme="dark"] {
            /* Dark mode variables */
            --bg-color: #0d1117;
            --bg-secondary: #161b22;
            --text-color: #e6edf3;
            --text-muted: #7d8590;
            --card-bg: #21262d;
            --card-header-bg: #2d333b;
            --border-color: #30363d;
            --navbar-bg: #1f2937;
            --navbar-text: #e6edf3;
            --table-border: #30363d;
            --shadow: rgba(0,0,0,0.3);
        }
        
        body {
            background-color: var(--bg-color) !important;
            color: var(--text-color) !important;
            transition: all 0.3s ease;
        }
        
        .card {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        .card-header {
            background-color: var(--card-header-bg) !important;
            color: var(--text-color) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }
        
        .table {
            color: var(--text-color) !important;
            --bs-table-border-color: var(--table-border);
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: var(--bg-secondary) !important;
        }
        
        .navbar-dark {
            background-color: var(--navbar-bg) !important;
        }
        
        .transaction-income { border-left: 4px solid #28a745; }
        .transaction-expense { border-left: 4px solid #dc3545; }
        .transaction-outstanding { border-left: 4px solid #ffc107; }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-overdue { background-color: #f8d7da; color: #721c24; }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .amount-positive { color: #28a745; font-weight: 600; }
        .amount-negative { color: #dc3545; font-weight: 600; }
        .amount-warning { color: #ffc107; font-weight: 600; }
        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .transaction-row:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .filter-buttons {
            margin-bottom: 1rem;
        }
        .filter-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-coins me-2"></i>Fraternity Treasurer
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('transactions') }}">All Transactions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('budget_management') }}">Budget</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('monthly_income') }}">Monthly Income</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-list-ul me-2"></i>All Financial Transactions
                </h1>
                
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">
                                    <i class="fas fa-arrow-up me-2"></i>Total Income
                                </h5>
                                <h3 class="amount-positive">${{ "%.2f"|format(total_income) }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">
                                    <i class="fas fa-arrow-down me-2"></i>Total Expenses
                                </h5>
                                <h3 class="amount-negative">${{ "%.2f"|format(total_expenses) }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning">
                                    <i class="fas fa-clock me-2"></i>Outstanding Dues
                                </h5>
                                <h3 class="amount-warning">${{ "%.2f"|format(total_outstanding) }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Net Balance Card -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="summary-card text-center">
                            <h4><i class="fas fa-calculator me-2"></i>Net Financial Position</h4>
                            {% set net_balance = total_income - total_expenses %}
                            <h2>
                                {% if net_balance >= 0 %}
                                    <i class="fas fa-plus-circle me-2"></i>${{ "%.2f"|format(net_balance) }}
                                {% else %}
                                    <i class="fas fa-minus-circle me-2"></i>-${{ "%.2f"|format(net_balance|abs) }}
                                {% endif %}
                            </h2>
                            <p class="mb-0">Current Balance (excluding outstanding dues)</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div class="filter-buttons">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Filter by Type:</h6>
                            <button class="btn btn-outline-primary filter-btn" onclick="filterTransactions('all')">
                                <i class="fas fa-list me-1"></i>All Items
                            </button>
                            <button class="btn btn-outline-success filter-btn" onclick="filterTransactions('income')">
                                <i class="fas fa-arrow-up me-1"></i>Income Only
                            </button>
                            <button class="btn btn-outline-danger filter-btn" onclick="filterTransactions('expense')">
                                <i class="fas fa-arrow-down me-1"></i>Expenses Only
                            </button>
                            <button class="btn btn-outline-warning filter-btn" onclick="filterTransactions('outstanding')">
                                <i class="fas fa-clock me-1"></i>Outstanding Dues
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Filter by Category:</h6>
                            <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                                <option value="all">All Categories</option>
                                {% set categories = transactions|map(attribute='category')|unique|list %}
                                {% for category in categories|sort %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Transaction Details
                            <span class="badge bg-light text-dark ms-2" id="itemCount">{{ transactions|length }} items</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Member</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    {% for item in transactions %}
                                    <tr class="transaction-row transaction-{{ item.transaction_type }}" 
                                        data-type="{{ item.transaction_type }}"
                                        data-category="{{ item.category }}"
                                        data-member="{{ item.member_name or '' }}">
                                        <td>
                                            <div class="fw-bold">{{ item.date_str.split(' ')[0] }}</div>
                                            {% if ' ' in item.date_str %}
                                            <small class="text-muted">{{ item.date_str.split(' ')[1] }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.transaction_type == 'income' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-arrow-up me-1"></i>Income
                                                </span>
                                            {% elif item.transaction_type == 'expense' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-arrow-down me-1"></i>Expense
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="fas fa-clock me-1"></i>Due
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ item.category }}</span>
                                        </td>
                                        <td>
                                            <div class="fw-bold">{{ item.description }}</div>
                                        </td>
                                        <td>
                                            {% if item.member_name %}
                                                <div class="text-primary fw-bold">{{ item.member_name }}</div>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.transaction_type == 'income' %}
                                                <span class="amount-positive">+${{ "%.2f"|format(item.amount) }}</span>
                                            {% elif item.transaction_type == 'expense' %}
                                                <span class="amount-negative">-${{ "%.2f"|format(item.amount) }}</span>
                                            {% else %}
                                                <span class="amount-warning">${{ "%.2f"|format(item.amount) }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.status == 'completed' %}
                                                <span class="badge status-completed">
                                                    <i class="fas fa-check me-1"></i>Completed
                                                </span>
                                            {% elif item.status == 'pending' %}
                                                <span class="badge status-pending">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                            {% elif item.status == 'overdue' %}
                                                <span class="badge status-overdue">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Overdue
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if item.type == 'transaction' %}
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{{ url_for('edit_transaction', transaction_id=item.id) }}" 
                                                       class="btn btn-outline-primary btn-sm" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <form method="POST" action="{{ url_for('remove_transaction', transaction_id=item.id) }}" 
                                                          class="d-inline" 
                                                          onsubmit="return confirm('Are you sure you want to delete this transaction?')">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            {% else %}
                                                <small class="text-muted">Outstanding dues</small>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- No Results Message (initially hidden) -->
                <div id="noResultsMessage" class="alert alert-info text-center mt-3" style="display: none;">
                    <i class="fas fa-search me-2"></i>No transactions match the current filter.
                </div>

                <!-- Back to Dashboard -->
                <div class="text-center mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTypeFilter = 'all';
        let currentCategoryFilter = 'all';

        function filterTransactions(filterType) {
            currentTypeFilter = filterType;
            applyFilters();
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');
        }

        function filterByCategory() {
            const categorySelect = document.getElementById('categoryFilter');
            currentCategoryFilter = categorySelect.value;
            applyFilters();
        }

        function applyFilters() {
            const rows = document.querySelectorAll('#transactionsTableBody tr');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const itemCount = document.getElementById('itemCount');
            let visibleCount = 0;

            rows.forEach(row => {
                const rowType = row.getAttribute('data-type');
                const rowCategory = row.getAttribute('data-category');
                
                const typeMatches = currentTypeFilter === 'all' || rowType === currentTypeFilter;
                const categoryMatches = currentCategoryFilter === 'all' || rowCategory === currentCategoryFilter;
                
                if (typeMatches && categoryMatches) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update item count
            itemCount.textContent = visibleCount + ' items';

            // Show/hide no results message
            if (visibleCount === 0) {
                noResultsMessage.style.display = 'block';
            } else {
                noResultsMessage.style.display = 'none';
            }
        }

        // Initialize with all items filter active
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelector('.filter-btn').classList.remove('btn-outline-primary');
            document.querySelector('.filter-btn').classList.add('btn-primary');
        });
    </script>
    <script>
        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            }
        });
    </script>
</body>
</html>
