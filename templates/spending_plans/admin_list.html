{% extends "base.html" %}

{% block title %}Spending Plans Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-calendar-event"></i> Spending Plans Management</h1>
                <div>
                    <a href="{{ url_for('spending_plans.spending_plans_summary') }}" 
                       class="btn btn-outline-info me-2">
                        <i class="bi bi-graph-up"></i> Summary
                    </a>
                    {% if has_permission('manage_own_budget') %}
                    <a href="{{ url_for('spending_plans.create_spending_plan') }}" 
                       class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Create New Plan
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-3" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                All Plans
                <span class="badge bg-secondary ms-1">{{ plans|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                Pending Review
                <span class="badge bg-warning ms-1">{{ plans|rejectattr('treasurer_approved')|list|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button">
                Approved
                <span class="badge bg-success ms-1">{{ plans|selectattr('treasurer_approved')|list|length }}</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="statusTabContent">
        <!-- All Plans Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            {% set display_plans = plans %}
            {% include 'spending_plans/partials/plans_table.html' %}
        </div>

        <!-- Pending Plans Tab -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            {% set display_plans = plans|rejectattr('treasurer_approved')|list %}
            {% include 'spending_plans/partials/plans_table.html' %}
        </div>

        <!-- Approved Plans Tab -->
        <div class="tab-pane fade" id="approved" role="tabpanel">
            {% set display_plans = plans|selectattr('treasurer_approved')|list %}
            {% include 'spending_plans/partials/plans_table.html' %}
        </div>
    </div>
</div>

<!-- Action Modals -->
{% if has_permission('manage_budgets') %}
<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Approve Spending Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this spending plan?</p>
                <div id="approveDetails"></div>
                <div class="mt-3">
                    <label for="approvalNotes" class="form-label">Approval Notes (Optional)</label>
                    <textarea class="form-control" id="approvalNotes" rows="3" 
                              placeholder="Add any notes or feedback for the officer..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApprove">
                    <i class="bi bi-check-circle"></i> Approve Plan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-x-circle"></i> Reject Spending Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="rejectDetails" class="mb-3"></div>
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Rejection Reason *</label>
                    <textarea class="form-control" id="rejectionReason" rows="4" 
                              placeholder="Please provide detailed feedback on why this plan is being rejected and suggestions for improvement..."></textarea>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    The officer will be able to revise and resubmit their plan based on your feedback.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmReject">
                    <i class="bi bi-x-circle"></i> Reject Plan
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPlanId = null;
    
    // Handle approve button clicks
    document.querySelectorAll('.approve-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentPlanId = this.dataset.id;
            const title = this.dataset.title;
            const category = this.dataset.category;
            const budget = parseFloat(this.dataset.budget);
            const events = parseInt(this.dataset.events);
            
            document.getElementById('approveDetails').innerHTML = `
                <div class="card bg-light">
                    <div class="card-body">
                        <h6>${title}</h6>
                        <div class="row">
                            <div class="col-sm-6">
                                <strong>Category:</strong> ${category}<br>
                                <strong>Total Budget:</strong> $${budget.toFixed(2)}
                            </div>
                            <div class="col-sm-6">
                                <strong>Events:</strong> ${events}<br>
                                <strong>Version:</strong> ${this.dataset.version}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('approvalNotes').value = '';
        });
    });

    // Handle reject button clicks
    document.querySelectorAll('.reject-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentPlanId = this.dataset.id;
            const title = this.dataset.title;
            const category = this.dataset.category;
            const budget = parseFloat(this.dataset.budget);
            
            document.getElementById('rejectDetails').innerHTML = `
                <div class="card bg-light">
                    <div class="card-body">
                        <h6>${title}</h6>
                        <div class="row">
                            <div class="col-sm-6">
                                <strong>Category:</strong> ${category}
                            </div>
                            <div class="col-sm-6">
                                <strong>Total Budget:</strong> $${budget.toFixed(2)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('rejectionReason').value = '';
        });
    });

    // Confirm approve
    document.getElementById('confirmApprove')?.addEventListener('click', function() {
        if (!currentPlanId) return;
        
        const notes = document.getElementById('approvalNotes').value.trim();
        
        this.disabled = true;
        this.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Approving...';
        
        fetch(`/spending-plans/${currentPlanId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notes: notes })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-check-circle"></i> Approve Plan';
            }
        })
        .catch(error => {
            alert('Error approving plan');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-check-circle"></i> Approve Plan';
        });
    });

    // Confirm reject
    document.getElementById('confirmReject')?.addEventListener('click', function() {
        if (!currentPlanId) return;
        
        const reason = document.getElementById('rejectionReason').value.trim();
        if (!reason) {
            alert('Please provide a rejection reason');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Rejecting...';
        
        fetch(`/spending-plans/${currentPlanId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-x-circle"></i> Reject Plan';
            }
        })
        .catch(error => {
            alert('Error rejecting plan');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-x-circle"></i> Reject Plan';
        });
    });

    // Auto-refresh every 2 minutes
    setTimeout(function() {
        location.reload();
    }, 120000);
});
</script>
{% endblock %}