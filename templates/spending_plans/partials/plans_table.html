<!-- Spending Plans Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Plan Details</th>
                        <th>Category</th>
                        <th>Budget</th>
                        <th>Events</th>
                        <th>Status</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in display_plans %}
                    {% set plan_data = plan.get_plan_data() %}
                    <tr>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-bold">{{ plan.title }}</span>
                                <small class="text-muted">v{{ plan.version }} â€¢ {{ plan.semester.name }}</small>
                                {% if plan_data.get('description') %}
                                <small class="text-muted" title="{{ plan_data.description }}">
                                    {{ plan_data.description[:80] }}{% if plan_data.description|length > 80 %}...{% endif %}
                                </small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ plan.category }}</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-success">${{ "{:,.2f}".format(plan_data.get('total_budget', 0)) }}</span>
                                {% if plan.treasurer_approved %}
                                <small class="text-muted">Allocated</small>
                                {% else %}
                                <small class="text-muted">Requested</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar-event text-info me-2"></i>
                                <span>{{ plan_data.get('events', [])|length }}</span>
                            </div>
                        </td>
                        <td>
                            {% if plan.treasurer_approved %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Approved
                                </span>
                                {% if plan_data.get('approval_date') %}
                                <br><small class="text-muted">{{ plan_data.approval_date[:10] }}</small>
                                {% endif %}
                            {% elif plan_data.get('status') == 'rejected' %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-x-circle"></i> Rejected
                                </span>
                                {% if plan_data.get('rejection_date') %}
                                <br><small class="text-muted">{{ plan_data.rejection_date[:10] }}</small>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-clock"></i> Pending Review
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span>{{ plan.updated_at.strftime('%m/%d/%Y') }}</span>
                                <small class="text-muted">{{ plan.updated_at.strftime('%I:%M %p') }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('spending_plans.view_spending_plan', id=plan.id) }}" 
                                   class="btn btn-sm btn-outline-primary" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                
                                {% if has_permission('manage_budgets') and not plan.treasurer_approved %}
                                <button class="btn btn-sm btn-success approve-btn" 
                                        data-bs-toggle="modal" data-bs-target="#approveModal"
                                        data-id="{{ plan.id }}"
                                        data-title="{{ plan.title }}"
                                        data-category="{{ plan.category }}"
                                        data-budget="{{ plan_data.get('total_budget', 0) }}"
                                        data-events="{{ plan_data.get('events', [])|length }}"
                                        data-version="{{ plan.version }}"
                                        title="Approve Plan">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger reject-btn"
                                        data-bs-toggle="modal" data-bs-target="#rejectModal"
                                        data-id="{{ plan.id }}"
                                        data-title="{{ plan.title }}"
                                        data-category="{{ plan.category }}"
                                        data-budget="{{ plan_data.get('total_budget', 0) }}"
                                        title="Reject Plan">
                                    <i class="bi bi-x"></i>
                                </button>
                                {% endif %}

                                {% if has_permission('manage_own_budget') and plan.created_by == current_user.id and not plan.treasurer_approved %}
                                <a href="{{ url_for('spending_plans.create_spending_plan') }}" 
                                   class="btn btn-sm btn-outline-warning" title="Revise Plan">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-calendar-plus fs-1"></i>
                            <div class="mt-2">No spending plans found</div>
                            {% if has_permission('manage_own_budget') %}
                            <div class="mt-2">
                                <a href="{{ url_for('spending_plans.create_spending_plan') }}" 
                                   class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Create Your First Plan
                                </a>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if display_plans %}
<!-- Summary Information -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div class="text-muted">
        Showing {{ display_plans|length }} plan{{ 's' if display_plans|length != 1 else '' }}
    </div>
    <div class="d-flex gap-3">
        {% set total_requested = display_plans|map(attribute='get_plan_data')|map(attribute='total_budget', default=0)|sum %}
        {% set approved_amount = display_plans|selectattr('treasurer_approved')|map(attribute='get_plan_data')|map(attribute='total_budget', default=0)|sum %}
        
        <small class="text-muted">
            Total Requested: <strong class="text-primary">${{ "{:,.2f}".format(total_requested) }}</strong>
        </small>
        {% if approved_amount > 0 %}
        <small class="text-muted">
            Total Approved: <strong class="text-success">${{ "{:,.2f}".format(approved_amount) }}</strong>
        </small>
        {% endif %}
    </div>
</div>
{% endif %}