<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Payment Schedule - {{ member.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .payment-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .remove-payment {
            color: #dc3545;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>Custom Payment Schedule</h1>
                    <a href="/edit_member/{{ member.id }}" class="btn btn-secondary">‚Üê Back to Edit Member</a>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Member Info -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>{{ member.name }}</h5>
                        <p class="text-muted">Total Dues: ${{ "%.2f"|format(member.dues_amount) }}</p>
                    </div>
                </div>

                <!-- Custom Payment Schedule Form -->
                <div class="card">
                    <div class="card-header">
                        <h5>üìÖ Create Custom Payment Schedule</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="payment-schedule-form">
                            <div id="payments-container">
                                <!-- Existing payments -->
                                {% if member.custom_schedule %}
                                    {% for payment in member.custom_schedule %}
                                        <div class="payment-item">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Due Date</label>
                                                    <input type="date" class="form-control" name="due_date_0" 
                                                           value="{{ payment.due_date[:10] }}" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Amount ($)</label>
                                                    <input type="number" class="form-control" name="amount_0" 
                                                           value="{{ payment.amount }}" step="0.01" required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Description</label>
                                                    <input type="text" class="form-control" name="description_0" 
                                                           value="{{ payment.description }}" required>
                                                </div>
                                                <div class="col-md-1 d-flex align-items-end">
                                                    <button type="button" class="btn btn-outline-danger remove-payment" 
                                                            onclick="removePayment(this)">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Default first payment -->
                                    <div class="payment-item">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Due Date</label>
                                                <input type="date" class="form-control" name="due_date_0" 
                                                       value="{{ (datetime.now() + timedelta(days=30)).strftime('%Y-%m-%d') }}" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Amount ($)</label>
                                                <input type="number" class="form-control" name="amount_0" 
                                                       value="{{ member.dues_amount }}" step="0.01" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Description</label>
                                                <input type="text" class="form-control" name="description_0" 
                                                       value="Payment 1" required>
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button" class="btn btn-outline-danger remove-payment" 
                                                        onclick="removePayment(this)">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addPayment()">
                                    ‚ûï Add Payment
                                </button>
                                <div>
                                    <span class="me-3">Total: $<span id="total-amount">0.00</span></span>
                                    <button type="submit" class="btn btn-success">üíæ Save Schedule</button>
                                </div>
                            </div>

                            <input type="hidden" name="payment_count" id="payment_count" value="1">
                        </form>

                        <div class="alert alert-info mt-3">
                            <strong>Tips:</strong>
                            <ul class="mb-0">
                                <li>Set specific due dates for each payment</li>
                                <li>Amounts can be different for each payment</li>
                                <li>Make sure the total adds up to the member's dues amount</li>
                                <li>Descriptions help identify each payment (e.g., "First Payment", "Final Payment")</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let paymentCount = {{ member.custom_schedule|length if member.custom_schedule else 1 }};

        function addPayment() {
            const container = document.getElementById('payments-container');
            const paymentItem = document.createElement('div');
            paymentItem.className = 'payment-item';
            
            // Calculate suggested due date (30 days from last payment)
            const lastDateInput = container.querySelector('input[type="date"]:last-of-type');
            let suggestedDate = new Date();
            if (lastDateInput && lastDateInput.value) {
                suggestedDate = new Date(lastDateInput.value);
                suggestedDate.setDate(suggestedDate.getDate() + 30);
            } else {
                suggestedDate.setDate(suggestedDate.getDate() + 30);
            }
            
            paymentItem.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" name="due_date_${paymentCount}" 
                               value="${suggestedDate.toISOString().split('T')[0]}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" class="form-control amount-input" name="amount_${paymentCount}" 
                               step="0.01" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description_${paymentCount}" 
                               value="Payment ${paymentCount + 1}" required>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger remove-payment" 
                                onclick="removePayment(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            
            container.appendChild(paymentItem);
            paymentCount++;
            updatePaymentCount();
            updateTotal();
        }

        function removePayment(button) {
            const paymentItem = button.closest('.payment-item');
            paymentItem.remove();
            updateTotal();
            updatePaymentCount();
        }

        function updatePaymentCount() {
            const count = document.querySelectorAll('.payment-item').length;
            document.getElementById('payment_count').value = count;
        }

        function updateTotal() {
            const amountInputs = document.querySelectorAll('.amount-input, input[name^="amount_"]');
            let total = 0;
            
            amountInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById('total-amount').textContent = total.toFixed(2);
            
            // Visual feedback if total doesn't match dues
            const duesAmount = {{ member.dues_amount }};
            const totalSpan = document.getElementById('total-amount');
            if (Math.abs(total - duesAmount) < 0.01) {
                totalSpan.className = 'text-success';
            } else {
                totalSpan.className = 'text-warning';
            }
        }

        // Add event listeners to existing amount inputs
        document.addEventListener('DOMContentLoaded', function() {
            updateTotal();
            
            // Add listeners to existing inputs
            document.querySelectorAll('input[name^="amount_"]').forEach(input => {
                input.addEventListener('input', updateTotal);
            });
        });

        // Add listener for dynamically added inputs
        document.addEventListener('input', function(e) {
            if (e.target.name && e.target.name.startsWith('amount_')) {
                updateTotal();
            }
        });
    </script>
</body>
</html>
