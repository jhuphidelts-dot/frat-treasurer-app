<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Fraternity Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.dashboard') }}">
                <i class="bi bi-people-fill"></i> Fraternity Management
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('main.dashboard') }}">
                    <i class="bi bi-house"></i> Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-people"></i> User Management
                    <small class="text-muted">Manage user accounts and roles</small>
                </h1>
                
                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
        </div>

        <!-- Pending Users -->
        {% if pending_users %}
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> Pending Approval 
                            <span class="badge bg-dark ms-2">{{ pending_users|length }}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Registered</th>
                                        <th>Roles</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in pending_users %}
                                    <tr>
                                        <td>
                                            <strong>{{ user.full_name }}</strong>
                                            <br><small class="text-muted">{{ user.phone }}</small>
                                        </td>
                                        <td>{{ user.phone }}</td>
                                        <td>{{ user.email or '-' }}</td>
                                        <td>
                                            <small>{{ user.created_at.strftime('%m/%d/%Y %I:%M %p') }}</small>
                                        </td>
                                        <td>
                                            {% for role in user.roles %}
                                                <span class="badge bg-secondary me-1">{{ role.name }}</span>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <!-- Approve Button -->
                                                <form method="POST" action="{{ url_for('auth.approve_user', user_id=user.id) }}" class="d-inline">
                                                    <button type="submit" class="btn btn-success" title="Approve User">
                                                        <i class="bi bi-check-circle"></i> Approve
                                                    </button>
                                                </form>
                                                
                                                <!-- Link to Member Button -->
                                                <button type="button" class="btn btn-info" data-bs-toggle="modal" 
                                                        data-bs-target="#linkMemberModal" data-user-id="{{ user.id }}" 
                                                        data-user-name="{{ user.full_name }}" title="Link to Existing Member">
                                                    <i class="bi bi-link-45deg"></i> Link
                                                </button>
                                                
                                                <!-- Manage Roles -->
                                                <a href="{{ url_for('auth.manage_user_roles', user_id=user.id) }}" 
                                                   class="btn btn-warning" title="Manage Roles">
                                                    <i class="bi bi-person-gear"></i> Roles
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Active Users -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle"></i> Active Users 
                            <span class="badge bg-light text-dark ms-2">{{ active_users|length }}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if active_users %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Contact</th>
                                        <th>Roles</th>
                                        <th>Linked Member</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in active_users %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                     style="width: 40px; height: 40px; font-size: 14px; font-weight: bold;">
                                                    {{ user.first_name[0] }}{{ user.last_name[0] }}
                                                </div>
                                                <div>
                                                    <strong>{{ user.full_name }}</strong>
                                                    <br><small class="text-muted">Joined {{ user.created_at.strftime('%m/%d/%Y') }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <i class="bi bi-phone"></i> {{ user.phone }}
                                            </div>
                                            {% if user.email %}
                                            <div>
                                                <i class="bi bi-envelope"></i> {{ user.email }}
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% for role in user.roles %}
                                                {% set role_colors = {
                                                    'treasurer': 'bg-danger',
                                                    'president': 'bg-warning text-dark',
                                                    'vice_president': 'bg-info',
                                                    'social_chair': 'bg-success',
                                                    'phi_ed_chair': 'bg-primary',
                                                    'recruitment_chair': 'bg-secondary',
                                                    'brotherhood_chair': 'bg-dark',
                                                    'brother': 'bg-light text-dark'
                                                } %}
                                                <span class="badge {{ role_colors.get(role.name, 'bg-secondary') }} me-1">
                                                    {{ role.name.replace('_', ' ').title() }}
                                                </span>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% if user.member_record %}
                                                <i class="bi bi-person-check text-success"></i>
                                                <strong>{{ user.member_record.name }}</strong>
                                                <br><small class="text-muted">${{ "%.2f"|format(user.member_record.dues_amount) }} dues</small>
                                            {% else %}
                                                <i class="bi bi-person-x text-warning"></i>
                                                <span class="text-muted">Not linked</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.approved_at %}
                                                <small>{{ user.approved_at.strftime('%m/%d/%Y') }}</small>
                                            {% else %}
                                                <span class="text-muted">Never</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <!-- Manage Roles -->
                                                <a href="{{ url_for('auth.manage_user_roles', user_id=user.id) }}" 
                                                   class="btn btn-outline-primary" title="Manage Roles">
                                                    <i class="bi bi-person-gear"></i>
                                                </a>
                                                
                                                {% if not user.member_record %}
                                                <!-- Link to Member (if not already linked) -->
                                                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" 
                                                        data-bs-target="#linkMemberModal" data-user-id="{{ user.id }}" 
                                                        data-user-name="{{ user.full_name }}" title="Link to Member">
                                                    <i class="bi bi-link-45deg"></i>
                                                </button>
                                                {% endif %}
                                                
                                                <!-- Suspend (if not treasurer) -->
                                                {% if not user.has_role('treasurer') %}
                                                <form method="POST" action="{{ url_for('auth.suspend_user', user_id=user.id) }}" 
                                                      class="d-inline" onsubmit="return confirm('Suspend {{ user.full_name }}?')">
                                                    <button type="submit" class="btn btn-outline-danger" title="Suspend User">
                                                        <i class="bi bi-person-slash"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">No active users yet</h5>
                            <p class="text-muted">Active users will appear here after approval.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Member Modal -->
    <div class="modal fade" id="linkMemberModal" tabindex="-1" aria-labelledby="linkMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="linkMemberModalLabel">
                        <i class="bi bi-link-45deg"></i> Link User to Member Record
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="linkMemberForm" method="POST">
                    <div class="modal-body">
                        <p>Select an existing member record to link with <strong id="selectedUserName"></strong>:</p>
                        
                        <div class="mb-3">
                            <label for="member_id" class="form-label">Available Members</label>
                            <select class="form-control" id="member_id" name="member_id" required>
                                <option value="">Loading members...</option>
                            </select>
                            <div class="form-text">Only members not already linked to accounts are shown.</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Note:</strong> Linking will automatically approve the user account and grant access to their dues information.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-link-45deg"></i> Link Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Handle link member modal
        const linkMemberModal = document.getElementById('linkMemberModal');
        linkMemberModal.addEventListener('show.bs.modal', async function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const userName = button.getAttribute('data-user-name');
            
            // Update modal content
            document.getElementById('selectedUserName').textContent = userName;
            document.getElementById('linkMemberForm').action = `/admin/link-member/${userId}`;
            
            // Load available members
            try {
                const response = await fetch('/api/unlinked-members');
                const members = await response.json();
                
                const select = document.getElementById('member_id');
                select.innerHTML = '<option value="">Select a member...</option>';
                
                if (members.length === 0) {
                    select.innerHTML = '<option value="">No unlinked members available</option>';
                    select.disabled = true;
                } else {
                    members.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.name} - ${member.contact} ($${member.dues_amount})`;
                        select.appendChild(option);
                    });
                    select.disabled = false;
                }
            } catch (error) {
                console.error('Error loading members:', error);
                document.getElementById('member_id').innerHTML = '<option value="">Error loading members</option>';
            }
        });

        // Auto-refresh for new registrations (every 30 seconds)
        setInterval(function() {
            // Check if there are pending users that need attention
            const pendingCount = {{ pending_users|length }};
            if (pendingCount > 0) {
                // Only refresh if page is visible to avoid unnecessary requests
                if (!document.hidden) {
                    location.reload();
                }
            }
        }, 30000);
    </script>
</body>
</html>