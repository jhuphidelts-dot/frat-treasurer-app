{% extends "base.html" %}

{% block title %}Member Directory{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-people"></i>
                Member Directory
            </h1>
            <p class="text-muted">
                Current members for {{ current_semester.name }}
                {% if not can_view_finances %}
                    <span class="badge bg-info">Contact Information Only</span>
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" id="memberSearch" class="form-control" placeholder="Search members...">
            </div>
        </div>
        <div class="col-md-6">
            <select id="roleFilter" class="form-select">
                <option value="">All Roles</option>
                <option value="president">President</option>
                <option value="vice_president">Vice President</option>
                <option value="treasurer">Treasurer</option>
                <option value="social_chair">Social Chair</option>
                <option value="phi_ed_chair">Phi Ed Chair</option>
                <option value="recruitment_chair">Recruitment Chair</option>
                <option value="brotherhood_chair">Brotherhood Chair</option>
                <option value="brother">Brother</option>
            </select>
        </div>
    </div>

    <!-- Members Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-list"></i>
                        Members ({{ members|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if members %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="membersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Role</th>
                                        {% if can_view_finances %}
                                            <th>Dues Amount</th>
                                            <th>Amount Paid</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                        {% endif %}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for member in members %}
                                    <tr data-role="{{ member.user_account.get_primary_role().name if member.user_account and member.user_account.get_primary_role() else 'brother' }}">
                                        <td>
                                            <strong>{{ member.name }}</strong>
                                            {% if member.user_account %}
                                                <br><small class="text-muted">
                                                    <i class="bi bi-person-check"></i> Linked Account
                                                </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if member.contact_type == 'email' %}
                                                <i class="bi bi-envelope"></i>
                                                <a href="mailto:{{ member.contact }}">{{ member.contact }}</a>
                                            {% else %}
                                                <i class="bi bi-phone"></i>
                                                <a href="tel:{{ member.contact }}">{{ member.contact }}</a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if member.user_account and member.user_account.get_primary_role() %}
                                                {% set role = member.user_account.get_primary_role() %}
                                                <span class="badge bg-{{ 'danger' if role.name == 'treasurer' else 'primary' if role.name == 'president' else 'success' if role.name == 'vice_president' else 'warning' if 'chair' in role.name else 'secondary' }}">
                                                    {{ role.name.replace('_', ' ').title() }}
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">Brother</span>
                                            {% endif %}
                                        </td>
                                        {% if can_view_finances %}
                                            <td>${{ "%.2f"|format(member.dues_amount) }}</td>
                                            <td>
                                                {% set total_paid = member.get_total_paid() %}
                                                ${{ "%.2f"|format(total_paid) }}
                                            </td>
                                            <td>
                                                {% set balance = member.get_balance() %}
                                                <span class="text-{{ 'success' if balance <= 0 else 'danger' }}">
                                                    ${{ "%.2f"|format(balance) }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if member.is_paid_up() %}
                                                    <span class="badge bg-success">Paid</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Outstanding</span>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if can_view_finances %}
                                                    <a href="{{ url_for('main.member_details', member_id=member.id) }}" 
                                                       class="btn btn-outline-primary btn-sm">
                                                        <i class="bi bi-eye"></i> View
                                                    </a>
                                                {% endif %}
                                                
                                                <!-- Contact Actions -->
                                                {% if member.contact_type == 'email' %}
                                                    <a href="mailto:{{ member.contact }}" 
                                                       class="btn btn-outline-secondary btn-sm">
                                                        <i class="bi bi-envelope"></i>
                                                    </a>
                                                {% else %}
                                                    <a href="sms:{{ member.contact }}" 
                                                       class="btn btn-outline-secondary btn-sm">
                                                        <i class="bi bi-chat"></i>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-people display-4"></i>
                            <h4 class="mt-3">No Members Found</h4>
                            <p>No members have been added for the current semester yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if can_view_finances %}
    <!-- Financial Summary -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Financial Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary">{{ members|length }}</h3>
                                <p class="mb-0">Total Members</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                {% set paid_members = members|selectattr('is_paid_up')|list %}
                                <h3 class="text-success">{{ paid_members|length }}</h3>
                                <p class="mb-0">Paid Up</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-danger">{{ members|length - paid_members|length }}</h3>
                                <p class="mb-0">Outstanding</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                {% set total_collected = members|sum(attribute='get_total_paid') %}
                                <h3 class="text-info">${{ "%.0f"|format(total_collected) }}</h3>
                                <p class="mb-0">Total Collected</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('memberSearch');
    const roleFilter = document.getElementById('roleFilter');
    const table = document.getElementById('membersTable');
    const rows = table.querySelectorAll('tbody tr');

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRole = roleFilter.value;

        rows.forEach(row => {
            const nameCell = row.cells[0].textContent.toLowerCase();
            const contactCell = row.cells[1].textContent.toLowerCase();
            const memberRole = row.getAttribute('data-role');
            
            const matchesSearch = nameCell.includes(searchTerm) || contactCell.includes(searchTerm);
            const matchesRole = !selectedRole || memberRole === selectedRole;
            
            if (matchesSearch && matchesRole) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update visible count
        const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
        console.log(`Showing ${visibleRows.length} of ${rows.length} members`);
    }

    searchInput.addEventListener('input', filterTable);
    roleFilter.addEventListener('change', filterTable);

    // Add sorting functionality
    const headers = table.querySelectorAll('th');
    headers.forEach((header, index) => {
        if (index < 3) { // Only make first 3 columns sortable
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                sortTable(index);
            });
        }
    });

    function sortTable(columnIndex) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const isAscending = table.getAttribute('data-sort-direction') !== 'asc';
        
        rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();
            
            if (isAscending) {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        });
        
        rows.forEach(row => tbody.appendChild(row));
        table.setAttribute('data-sort-direction', isAscending ? 'asc' : 'desc');
    }
});
</script>
{% endblock %}