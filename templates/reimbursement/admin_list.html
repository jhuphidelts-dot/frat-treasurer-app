{% extends "base.html" %}

{% block title %}Reimbursement Requests{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-receipt"></i> Reimbursement Requests</h1>
                <div>
                    {% if has_permission('submit_reimbursement') %}
                    <a href="{{ url_for('reimbursement.create_reimbursement') }}" 
                       class="btn btn-primary me-2">
                        <i class="bi bi-plus-circle"></i> Submit New Request
                    </a>
                    {% endif %}
                    <a href="{{ url_for('reimbursement.reimbursement_summary') }}" 
                       class="btn btn-outline-info">
                        <i class="bi bi-graph-up"></i> Summary
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-3" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                All Requests 
                <span class="badge bg-secondary ms-1">{{ requests|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                Pending 
                <span class="badge bg-warning ms-1">{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button">
                Approved 
                <span class="badge bg-success ms-1">{{ requests|selectattr('status', 'equalto', 'approved')|list|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button">
                Rejected 
                <span class="badge bg-danger ms-1">{{ requests|selectattr('status', 'equalto', 'rejected')|list|length }}</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="statusTabContent">
        <!-- All Requests Tab -->
        <div class="tab-pane fade show active" id="all" role="tabpanel">
            {% include 'reimbursement/partials/request_table.html' %}
        </div>

        <!-- Pending Requests Tab -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            {% set pending_requests = requests|selectattr('status', 'equalto', 'pending')|list %}
            {% include 'reimbursement/partials/request_table.html' %}
        </div>

        <!-- Approved Requests Tab -->
        <div class="tab-pane fade" id="approved" role="tabpanel">
            {% set approved_requests = requests|selectattr('status', 'equalto', 'approved')|list %}
            {% include 'reimbursement/partials/request_table.html' %}
        </div>

        <!-- Rejected Requests Tab -->
        <div class="tab-pane fade" id="rejected" role="tabpanel">
            {% set rejected_requests = requests|selectattr('status', 'equalto', 'rejected')|list %}
            {% include 'reimbursement/partials/request_table.html' %}
        </div>
    </div>
</div>

<!-- Action Modals -->
{% if has_permission('approve_reimbursements') %}
<!-- Approve Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Approve Reimbursement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve this reimbursement request?</p>
                <div id="approveDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmApprove">
                    <i class="bi bi-check-circle"></i> Approve
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-x-circle"></i> Reject Reimbursement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="rejectDetails" class="mb-3"></div>
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Rejection Reason *</label>
                    <textarea class="form-control" id="rejectionReason" rows="3" 
                              placeholder="Please provide a reason for rejecting this request..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmReject">
                    <i class="bi bi-x-circle"></i> Reject
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentRequestId = null;
    
    // Handle approve button clicks
    document.querySelectorAll('.approve-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentRequestId = this.dataset.id;
            const amount = this.dataset.amount;
            const description = this.dataset.description;
            const member = this.dataset.member;
            
            document.getElementById('approveDetails').innerHTML = `
                <strong>Member:</strong> ${member}<br>
                <strong>Amount:</strong> $${parseFloat(amount).toFixed(2)}<br>
                <strong>Description:</strong> ${description}
            `;
        });
    });

    // Handle reject button clicks
    document.querySelectorAll('.reject-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentRequestId = this.dataset.id;
            const amount = this.dataset.amount;
            const description = this.dataset.description;
            const member = this.dataset.member;
            
            document.getElementById('rejectDetails').innerHTML = `
                <strong>Member:</strong> ${member}<br>
                <strong>Amount:</strong> $${parseFloat(amount).toFixed(2)}<br>
                <strong>Description:</strong> ${description}
            `;
            document.getElementById('rejectionReason').value = '';
        });
    });

    // Confirm approve
    document.getElementById('confirmApprove')?.addEventListener('click', function() {
        if (!currentRequestId) return;
        
        this.disabled = true;
        this.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Approving...';
        
        fetch(`/reimbursements/${currentRequestId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-check-circle"></i> Approve';
            }
        })
        .catch(error => {
            alert('Error approving request');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-check-circle"></i> Approve';
        });
    });

    // Confirm reject
    document.getElementById('confirmReject')?.addEventListener('click', function() {
        if (!currentRequestId) return;
        
        const reason = document.getElementById('rejectionReason').value.trim();
        if (!reason) {
            alert('Please provide a rejection reason');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Rejecting...';
        
        fetch(`/reimbursements/${currentRequestId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-x-circle"></i> Reject';
            }
        })
        .catch(error => {
            alert('Error rejecting request');
            this.disabled = false;
            this.innerHTML = '<i class="bi bi-x-circle"></i> Reject';
        });
    });

    // Auto-refresh every 30 seconds
    setTimeout(function() {
        location.reload();
    }, 30000);
});
</script>
{% endblock %}